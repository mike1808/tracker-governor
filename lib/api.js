"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _querystring = _interopRequireDefault(require("querystring"));

var _util = require("util");

var _config = _interopRequireDefault(require("./config"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function fetchDryRun(url, options) {
  console.log(`fetching ${url} with options: ${(0, _util.inspect)(options)}`);
  return Promise.resolve({
    ok: true,
    status: 200,
    json: () => Promise.resolve({})
  });
}

class TrackerAPI {
  constructor(token) {
    this.token = token;
  }

  _headers(headers = {}) {
    return {
      'X-TrackerToken': this.token,
      ...headers
    };
  }

  async stories(projectId, query = {}) {
    return (0, _nodeFetch.default)(`https://www.pivotaltracker.com/services/v5/projects/${projectId}/stories?${_querystring.default.stringify(query)}`, {
      headers: this._headers()
    }).then(res => res.json().then(response => ({
      status: res.status,
      ok: res.ok,
      response
    })));
  }

  async storiesById(projectId, ids) {
    return (0, _nodeFetch.default)(`https://www.pivotaltracker.com/services/v5/projects/${projectId}/stories/bulk?${_querystring.default.stringify({
      ids: ids.join(',')
    })}`, {
      headers: this._headers()
    }).then(res => res.json().then(response => ({
      status: res.status,
      ok: res.ok,
      response
    })));
  }

  async updateStory(projectId, storyId, update) {
    return (_config.default.dev ? fetchDryRun : _nodeFetch.default)(`https://www.pivotaltracker.com/services/v5/projects/${projectId}/stories/${storyId}`, {
      method: 'put',
      headers: this._headers({
        'content-type': 'application/json'
      }),
      body: JSON.stringify(update)
    }).then(res => res.json() // $FlowFixMe ignore
    .then(response => ({
      status: res.status,
      ok: res.ok,
      response
    })));
  }

  async postComment(projectId, storyId, comment) {
    return (_config.default.dev ? fetchDryRun : _nodeFetch.default)(`https://www.pivotaltracker.com/services/v5/projects/${projectId}/stories/${storyId}/comments`, {
      method: 'post',
      headers: this._headers({
        'content-type': 'application/json'
      }),
      body: JSON.stringify({
        text: comment
      })
    }).then(res => res.json() // $FlowFixMe ignore
    .then(response => ({
      status: res.status,
      ok: res.ok,
      response
    })));
  }

}

var _default = new TrackerAPI(_config.default.apiToken);

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9hcGkuanMiXSwibmFtZXMiOlsiZmV0Y2hEcnlSdW4iLCJ1cmwiLCJvcHRpb25zIiwiY29uc29sZSIsImxvZyIsIlByb21pc2UiLCJyZXNvbHZlIiwib2siLCJzdGF0dXMiLCJqc29uIiwiVHJhY2tlckFQSSIsImNvbnN0cnVjdG9yIiwidG9rZW4iLCJfaGVhZGVycyIsImhlYWRlcnMiLCJzdG9yaWVzIiwicHJvamVjdElkIiwicXVlcnkiLCJxcyIsInN0cmluZ2lmeSIsInRoZW4iLCJyZXMiLCJyZXNwb25zZSIsInN0b3JpZXNCeUlkIiwiaWRzIiwiam9pbiIsInVwZGF0ZVN0b3J5Iiwic3RvcnlJZCIsInVwZGF0ZSIsImNvbmZpZyIsImRldiIsImZldGNoIiwibWV0aG9kIiwiYm9keSIsIkpTT04iLCJwb3N0Q29tbWVudCIsImNvbW1lbnQiLCJ0ZXh0IiwiYXBpVG9rZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQStEQSxTQUFTQSxXQUFULENBQXFCQyxHQUFyQixFQUEwQkMsT0FBMUIsRUFBbUM7QUFDakNDLEVBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLFlBQVdILEdBQUksa0JBQWlCLG1CQUFRQyxPQUFSLENBQWlCLEVBQTlEO0FBRUEsU0FBT0csT0FBTyxDQUFDQyxPQUFSLENBQWdCO0FBQ3JCQyxJQUFBQSxFQUFFLEVBQUUsSUFEaUI7QUFFckJDLElBQUFBLE1BQU0sRUFBRSxHQUZhO0FBR3JCQyxJQUFBQSxJQUFJLEVBQUUsTUFBTUosT0FBTyxDQUFDQyxPQUFSLENBQWdCLEVBQWhCO0FBSFMsR0FBaEIsQ0FBUDtBQUtEOztBQUVELE1BQU1JLFVBQU4sQ0FBaUI7QUFHZkMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWdCO0FBQ3pCLFNBQUtBLEtBQUwsR0FBYUEsS0FBYjtBQUNEOztBQUVEQyxFQUFBQSxRQUFRLENBQUNDLE9BQVcsR0FBRyxFQUFmLEVBQW1CO0FBQ3pCLFdBQU87QUFD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YSxHQUFHLENBQUNiLE1BQWQ7QUFBc0JELE1BQUFBLEVBQUUsRUFBRWMsR0FBRyxDQUFDZCxFQUE5QjtBQUFrQ2UsTUFBQUE7QUFBbEMsS0FBTCxDQUhoQixDQVpLLENBQVA7QUFpQkQ7O0FBaEdjOztlQW1HRixJQUFJWixVQUFKLENBQWVtQixnQkFBT1MsUUFBdEIsQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJ1xuaW1wb3J0IHFzIGZyb20gJ3F1ZXJ5c3RyaW5nJ1xuaW1wb3J0IHsgaW5zcGVjdCB9IGZyb20gJ3V0aWwnXG5pbXBvcnQgY29uZmlnIGZyb20gJy4vY29uZmlnJ1xuXG5leHBvcnQgdHlwZSBTdG9yeVN0YXRlID1cbiAgfCAnYWNjZXB0ZWQnXG4gIHwgJ2RlbGl2ZXJlZCdcbiAgfCAnZmluaXNoZWQnXG4gIHwgJ3N0YXJ0ZWQnXG4gIHwgJ3JlamVjdGVkJ1xuICB8ICdwbGFubmVkJ1xuICB8ICd1bnN0YXJ0ZWQnXG4gIHwgJ3Vuc2NoZWR1bGVkJ1xuXG5leHBvcnQgdHlwZSBTdG9yeVR5cGUgPSAnZmVhdHVyZScgfCAnYnVnJyB8ICdjaG9yZScgfCAncmVsZWFzZSdcblxuZXhwb3J0IHR5cGUgU3RvcnkgPSB7fFxuICBpZDogbnVtYmVyLFxuICBwcm9qZWN0X2lkOiBudW1iZXIsXG4gIG5hbWU6IHN0cmluZyxcbiAgZGVzY3JpcHRpb246IHN0cmluZyxcbiAgc3RvcnlfdHlwZTogU3RvcnlUeXBlLFxuICBraW5kOiAnc3RvcnknLFxuICBjdXJyZW50X3N0YXRlOiBTdG9yeVN0YXRlLFxuICBlc3RpbWF0ZT86IG51bWJlcixcbiAgYWNjZXB0ZWRfYXQ6IHN0cmluZyxcbiAgJ2RlYWRsaW5lPyc6IHN0cmluZyxcbiAgcHJvamVjdGVkX2NvbXBsZXRpb24/OiBzdHJpbmcsXG4gIHBvaW50c19hY2NlcHRlZD86IG51bWJlcixcbiAgcG9pbnRzX3RvdGFsPzogbnVtYmVyLFxuICBwb2ludHNfdG90YWw/OiBudW1iZXIsXG4gIGNyZWF0ZWRfYXQ6IHN0cmluZyxcbiAgdXBkYXRlZF9hdDogc3RyaW5nLFxuICByZXF1ZXN0ZWRfYnlfaWQ6IG51bWJlcixcbiAgdXJsOiBzdHJpbmcsXG4gIG93bmVyX2lkczogbnVtYmVyW10sXG4gIGxhYmVsczogc3RyaW5nW10sXG4gIG93bmVkX2J5X2lkOiBudW1iZXIsXG58fVxuXG5leHBvcnQgdHlwZSBBY3Rpdml0eSA9IHt8XG4gIGtpbmQ6IHN0cmluZyxcbiAgZ3VpZDogc3RyaW5nLFxuICBwcm9qZWN0X3ZlcnNpb246IHN0cmluZyxcbiAgbWVzc2FnZTogc3RyaW5nLFxuICBoaWdobGlnaHQ6IHN0cmluZyxcbiAgY2hhbmdlczogYW55W10sXG4gIHByaW1hcnlfcmVzb3VyY2VzOiBhbnlbXSxcbiAgc2Vjb25kYXJ5X3Jlc291cmNlczogYW55W10sXG4gIHByb2plY3RfaWQ6IG51bWJlcixcbiAgcGVyZm9ybV9ieV9pZDogbnVtYmVyLFxuICBvY2N1cnJlZF9hdDogc3RyaW5nLFxuICBwcm9qZWN0OiB7fFxuICAgIGtpbmQ6ICdwcm9qZWN0JyxcbiAgICBpZDogbnVtYmVyLFxuICAgIG5hbWU6IHN0cmluZyxcbiAgfH0sXG58fVxuXG50eXBlIFJlc3BvbnNlPEJvZHk+ID0ge3xcbiAgb2s6IGJvb2xlYW4sXG4gIHN0YXR1czogbnVtYmVyLFxuICByZXNwb25zZTogQm9keSxcbnx9XG5cbmZ1bmN0aW9uIGZldGNoRHJ5UnVuKHVybCwgb3B0aW9ucykge1xuICBjb25zb2xlLmxvZyhgZmV0Y2hpbmcgJHt1cmx9IHdpdGggb3B0aW9uczogJHtpbnNwZWN0KG9wdGlvbnMpfWApXG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgb2s6IHRydWUsXG4gICAgc3RhdHVzOiAyMDAsXG4gICAganNvbjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHt9KSxcbiAgfSlcbn1cblxuY2xhc3MgVHJhY2tlckFQSSB7XG4gIHRva2VuOiBzdHJpbmdcblxuICBjb25zdHJ1Y3Rvcih0b2tlbjogc3RyaW5nKSB7XG4gICAgdGhpcy50b2tlbiA9IHRva2VuXG4gIH1cblxuICBfaGVhZGVycyhoZWFkZXJzOiB7fSA9IHt9KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICdYLVRyYWNrZXJUb2tlbic6IHRoaXMudG9rZW4sXG4gICAgICAuLi5oZWFkZXJzLFxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3JpZXMocHJvamVjdElkOiBudW1iZXIsIHF1ZXJ5OiB7fSA9IHt9KTogUHJvbWlzZTxSZXNwb25zZTxTdG9yeVtdPj4ge1xuICAgIHJldHVybiBmZXRjaChcbiAgICAgIGBodHRwczovL3d3dy5waXZvdGFsdHJhY2tlci5jb20vc2VydmljZXMvdjUvcHJvamVjdHMvJHtwcm9qZWN0SWR9L3N0b3JpZXM/JHtxcy5zdHJpbmdpZnkoXG4gICAgICAgIHF1ZXJ5XG4gICAgICApfWAsXG4gICAgICB7XG4gICAgICAgIGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSxcbiAgICAgIH1cbiAgICApLnRoZW4ocmVzID0+XG4gICAgICByZXMuanNvbigpLnRoZW4oKHJlc3BvbnNlOiBTdG9yeVtdKSA9PiAoe1xuICAgICAgICBzdGF0dXM6IHJlcy5zdGF0dXMsXG4gICAgICAgIG9rOiByZXMub2ssXG4gICAgICAgIHJlc3BvbnNlLFxuICAgICAgfSkpXG4gICAgKVxuICB9XG5cbiAgYXN5bmMgc3Rvcmllc0J5SWQoXG4gICAgcHJvamVjdElkOiBudW1iZXIsXG4gICAgaWRzOiBudW1iZXJbXVxuICApOiBQcm9taXNlPFJlc3BvbnNlPFN0b3J5W10+PiB7XG4gICAgcmV0dXJuIGZldGNoKFxuICAgICAgYGh0dHBzOi8vd3d3LnBpdm90YWx0cmFja2VyLmNvbS9zZXJ2aWNlcy92NS9wcm9qZWN0cy8ke3Byb2plY3RJZH0vc3Rvcmllcy9idWxrPyR7cXMuc3RyaW5naWZ5KFxuICAgICAgICB7XG4gICAgICAgICAgaWRzOiBpZHMuam9pbignLCcpLFxuICAgICAgICB9XG4gICAgICApfWAsXG4gICAgICB7XG4gICAgICAgIGhlYWRlcnM6IHRoaXMuX2hlYWRlcnMoKSxcbiAgICAgIH1cbiAgICApLnRoZW4ocmVzID0+XG4gICAgICByZXMuanNvbigpLnRoZW4oKHJlc3BvbnNlOiBTdG9yeVtdKSA9PiAoe1xuICAgICAgICBzdGF0dXM6IHJlcy5zdGF0dXMsXG4gICAgICAgIG9rOiByZXMub2ssXG4gICAgICAgIHJlc3BvbnNlLFxuICAgICAgfSkpXG4gICAgKVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlU3RvcnkoXG4gICAgcHJvamVjdElkOiBudW1iZXIsXG4gICAgc3RvcnlJZDogbnVtYmVyLFxuICAgIHVwZGF0ZTogJFNoYXBlPFN0b3J5PlxuICApOiBQcm9taXNlPFJlc3BvbnNlPFN0b3J5Pj4ge1xuICAgIHJldHVybiAoY29uZmlnLmRldiA/IGZldGNoRHJ5UnVuIDogZmV0Y2gpKFxuICAgICAgYGh0dHBzOi8vd3d3LnBpdm90YWx0cmFja2VyLmNvbS9zZXJ2aWNlcy92NS9wcm9qZWN0cy8ke3Byb2plY3RJZH0vc3Rvcmllcy8ke3N0b3J5SWR9YCxcbiAgICAgIHtcbiAgICAgICAgbWV0aG9kOiAncHV0JyxcbiAgICAgICAgaGVhZGVyczogdGhpcy5faGVhZGVycyh7XG4gICAgICAgICAgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSksXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHVwZGF0ZSksXG4gICAgICB9XG4gICAgKS50aGVuKHJlcyA9PlxuICAgICAgcmVzXG4gICAgICAgIC5qc29uKClcbiAgICAgICAgLy8gJEZsb3dGaXhNZSBpZ25vcmVcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gKHsgc3RhdHVzOiByZXMuc3RhdHVzLCBvazogcmVzLm9rLCByZXNwb25zZSB9KSlcbiAgICApXG4gIH1cbiAgYXN5bmMgcG9zdENvbW1lbnQoXG4gICAgcHJvamVjdElkOiBudW1iZXIsXG4gICAgc3RvcnlJZDogbnVtYmVyLFxuICAgIGNvbW1lbnQ6IHN0cmluZ1xuICApOiBQcm9taXNlPFJlc3BvbnNlPHZvaWQ+PiB7XG4gICAgcmV0dXJuIChjb25maWcuZGV2ID8gZmV0Y2hEcnlSdW4gOiBmZXRjaCkoXG4gICAgICBgaHR0cHM6Ly93d3cucGl2b3RhbHRyYWNrZXIuY29tL3NlcnZpY2VzL3Y1L3Byb2plY3RzLyR7cHJvamVjdElkfS9zdG9yaWVzLyR7c3RvcnlJZH0vY29tbWVudHNgLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgICAgaGVhZGVyczogdGhpcy5faGVhZGVycyh7XG4gICAgICAgICAgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSksXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICB0ZXh0OiBjb21tZW50LFxuICAgICAgICB9KSxcbiAgICAgIH1cbiAgICApLnRoZW4ocmVzID0+XG4gICAgICByZXNcbiAgICAgICAgLmpzb24oKVxuICAgICAgICAvLyAkRmxvd0ZpeE1lIGlnbm9yZVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiAoeyBzdGF0dXM6IHJlcy5zdGF0dXMsIG9rOiByZXMub2ssIHJlc3BvbnNlIH0pKVxuICAgIClcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBuZXcgVHJhY2tlckFQSShjb25maWcuYXBpVG9rZW4pXG4iXX0=