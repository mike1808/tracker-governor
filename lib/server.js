"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _express = _interopRequireDefault(require("express"));

var _util = require("util");

var _config = _interopRequireDefault(require("./config"));

var _common = require("./common");

var _sync = require("./sync");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const app = (0, _express.default)();
app.use(_express.default.json());
app.use(_express.default.urlencoded({
  extended: true
}));
app.get('/', (req, res) => {
  res.end();
});
app.post('/', async (req, res) => {
  res.end();
  console.log('Received activity');
  console.log((0, _util.inspect)(req.body, {
    colors: true,
    depth: null
  }));

  if (!needToProcess(req.body, app.get('storiesToTrack'), app.get('projects').private)) {
    console.log('Not processing');
    return;
  }

  console.log('Processing...');
  const story = getAggregatedState(req.body, app.get('privateIdToPublicId'));
  console.log('Will update to', (0, _util.inspect)(story, {
    colors: true
  }));
  (0, _sync.printStories)([story]);
  const response = await (0, _sync.syncPublicStoriesState)(app.get('projects').public, [story]);

  if (response.length && response[0]) {
    console.log('Successfully updated');
    await (0, _common.commentAboutSyncedState)(app.get('projects').public, [story]);
  } else {
    console.log('Cannot updated');
  }
});

async function _default(publicProjectId, privateProjectId) {
  app.set('projects', {
    public: publicProjectId,
    private: privateProjectId
  });
  const privateStoriesInPublicProject = await (0, _common.fetchPrivateStoriesFromPublicProject)(publicProjectId);
  const privateIdToPublicId = new Map();
  privateStoriesInPublicProject.forEach(story => {
    privateIdToPublicId.set(story.privateId, story.id);
  });
  app.set('storiesToTrack', privateStoriesInPublicProject);
  app.set('privateIdToPublicId', privateIdToPublicId);
  await (0, _util.promisify)(app.listen.bind(app))(_config.default.port);
  return _config.default.port;
}

function needToProcess(activity, stories, privateProjectId) {
  const storyIds = stories.map(story => story.privateId);
  return true && activity.project.id === privateProjectId && activity.kind === 'story_update_activity' && activity.primary_resources.length && activity.primary_resources[0].kind === 'story' && storyIds.includes(activity.primary_resources[0].id) && activity.changes.length && activity.changes[0].new_values.current_state != null;
}

function getAggregatedState(activity, privateIdToPublicId) {
  const privateStory = activity.primary_resources[0];
  const publicId = privateIdToPublicId.get(privateStory.id);
  return {
    privateId: privateStory.id,
    publicId,
    name: privateStory.name,
    currentState: activity.changes[0].original_values.current_state,
    actualState: activity.changes[0].new_values.current_state,
    privateUrl: privateStory.url,
    publicUrl: (0, _common.getStoryUrl)(publicId)
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2ZXIuanMiXSwibmFtZXMiOlsiYXBwIiwidXNlIiwiZXhwcmVzcyIsImpzb24iLCJ1cmxlbmNvZGVkIiwiZXh0ZW5kZWQiLCJnZXQiLCJyZXEiLCJyZXMiLCJlbmQiLCJwb3N0IiwiY29uc29sZSIsImxvZyIsImJvZHkiLCJjb2xvcnMiLCJkZXB0aCIsIm5lZWRUb1Byb2Nlc3MiLCJwcml2YXRlIiwic3RvcnkiLCJnZXRBZ2dyZWdhdGVkU3RhdGUiLCJyZXNwb25zZSIsInB1YmxpYyIsImxlbmd0aCIsInB1YmxpY1Byb2plY3RJZCIsInByaXZhdGVQcm9qZWN0SWQiLCJzZXQiLCJwcml2YXRlU3Rvcmllc0luUHVibGljUHJvamVjdCIsInByaXZhdGVJZFRvUHVibGljSWQiLCJNYXAiLCJmb3JFYWNoIiwicHJpdmF0ZUlkIiwiaWQiLCJsaXN0ZW4iLCJiaW5kIiwiY29uZmlnIiwicG9ydCIsImFjdGl2aXR5Iiwic3RvcmllcyIsInN0b3J5SWRzIiwibWFwIiwicHJvamVjdCIsImtpbmQiLCJwcmltYXJ5X3Jlc291cmNlcyIsImluY2x1ZGVzIiwiY2hhbmdlcyIsIm5ld192YWx1ZXMiLCJjdXJyZW50X3N0YXRlIiwicHJpdmF0ZVN0b3J5IiwicHVibGljSWQiLCJuYW1lIiwiY3VycmVudFN0YXRlIiwib3JpZ2luYWxfdmFsdWVzIiwiYWN0dWFsU3RhdGUiLCJwcml2YXRlVXJsIiwidXJsIiwicHVibGljVXJsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBS0E7Ozs7QUFHQSxNQUFNQSxHQUFHLEdBQUcsdUJBQVo7QUFFQUEsR0FBRyxDQUFDQyxHQUFKLENBQVFDLGlCQUFRQyxJQUFSLEVBQVI7QUFDQUgsR0FBRyxDQUFDQyxHQUFKLENBQVFDLGlCQUFRRSxVQUFSLENBQW1CO0FBQUVDLEVBQUFBLFFBQVEsRUFBRTtBQUFaLENBQW5CLENBQVI7QUFFQUwsR0FBRyxDQUFDTSxHQUFKLENBQVEsR0FBUixF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YUFMdkM7QUFNTE8sSUFBQUEsVUFBVSxFQUFFTixZQUFZLENBQUNPLEdBTnBCO0FBT0xDLElBQUFBLFNBQVMsRUFBRSx5QkFBWVAsUUFBWjtBQVBOLEdBQVA7QUFTRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnXG5pbXBvcnQgeyBwcm9taXNpZnksIGluc3BlY3QgfSBmcm9tICd1dGlsJ1xuaW1wb3J0IGNvbmZpZyBmcm9tICcuL2NvbmZpZydcbmltcG9ydCB0eXBlIHsgQWN0aXZpdHksIFN0b3J5U3RhdGUgfSBmcm9tICcuL2FwaSdcbmltcG9ydCB7XG4gIGZldGNoUHJpdmF0ZVN0b3JpZXNGcm9tUHVibGljUHJvamVjdCxcbiAgZ2V0U3RvcnlVcmwsXG4gIGNvbW1lbnRBYm91dFN5bmNlZFN0YXRlLFxufSBmcm9tICcuL2NvbW1vbidcbmltcG9ydCB7IHN5bmNQdWJsaWNTdG9yaWVzU3RhdGUsIHByaW50U3RvcmllcyB9IGZyb20gJy4vc3luYydcbmltcG9ydCB0eXBlIHsgUHJpdmF0ZVN0b3J5SW5QdWJsaWNQcm9qZWN0LCBTdG9yeUFnZ3JlZ2F0ZWQgfSBmcm9tICcuL2NvbW1vbidcblxuY29uc3QgYXBwID0gZXhwcmVzcygpXG5cbmFwcC51c2UoZXhwcmVzcy5qc29uKCkpXG5hcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pKVxuXG5hcHAuZ2V0KCcvJywgKHJlcSwgcmVzKSA9PiB7XG4gIHJlcy5lbmQoKVxufSlcblxuYXBwLnBvc3QoJy8nLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgcmVzLmVuZCgpXG5cbiAgY29uc29sZS5sb2coJ1JlY2VpdmVkIGFjdGl2aXR5JylcbiAgY29uc29sZS5sb2coaW5zcGVjdChyZXEuYm9keSwgeyBjb2xvcnM6IHRydWUsIGRlcHRoOiBudWxsIH0pKVxuXG4gIGlmIChcbiAgICAhbmVlZFRvUHJvY2VzcyhcbiAgICAgIHJlcS5ib2R5LFxuICAgICAgYXBwLmdldCgnc3Rvcmllc1RvVHJhY2snKSxcbiAgICAgIGFwcC5nZXQoJ3Byb2plY3RzJykucHJpdmF0ZVxuICAgIClcbiAgKSB7XG4gICAgY29uc29sZS5sb2coJ05vdCBwcm9jZXNzaW5nJylcbiAgICByZXR1cm5cbiAgfVxuXG4gIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nLi4uJylcblxuICBjb25zdCBzdG9yeSA9IGdldEFnZ3JlZ2F0ZWRTdGF0ZShyZXEuYm9keSwgYXBwLmdldCgncHJpdmF0ZUlkVG9QdWJsaWNJZCcpKVxuXG4gIGNvbnNvbGUubG9nKCdXaWxsIHVwZGF0ZSB0bycsIGluc3BlY3Qoc3RvcnksIHsgY29sb3JzOiB0cnVlIH0pKVxuXG4gIHByaW50U3Rvcmllcyhbc3RvcnldKVxuXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc3luY1B1YmxpY1N0b3JpZXNTdGF0ZShhcHAuZ2V0KCdwcm9qZWN0cycpLnB1YmxpYywgW1xuICAgIHN0b3J5LFxuICBdKVxuXG4gIGlmIChyZXNwb25zZS5sZW5ndGggJiYgcmVzcG9uc2VbMF0pIHtcbiAgICBjb25zb2xlLmxvZygnU3VjY2Vzc2Z1bGx5IHVwZGF0ZWQnKVxuICAgIGF3YWl0IGNvbW1lbnRBYm91dFN5bmNlZFN0YXRlKGFwcC5nZXQoJ3Byb2plY3RzJykucHVibGljLCBbc3RvcnldKVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKCdDYW5ub3QgdXBkYXRlZCcpXG4gIH1cbn0pXG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uKFxuICBwdWJsaWNQcm9qZWN0SWQ6IG51bWJlcixcbiAgcHJpdmF0ZVByb2plY3RJZDogbnVtYmVyXG4pIHtcbiAgYXBwLnNldCgncHJvamVjdHMnLCB7XG4gICAgcHVibGljOiBwdWJsaWNQcm9qZWN0SWQsXG4gICAgcHJpdmF0ZTogcHJpdmF0ZVByb2plY3RJZCxcbiAgfSlcblxuICBjb25zdCBwcml2YXRlU3Rvcmllc0luUHVibGljUHJvamVjdDogUHJpdmF0ZVN0b3J5SW5QdWJsaWNQcm9qZWN0ID0gYXdhaXQgZmV0Y2hQcml2YXRlU3Rvcmllc0Zyb21QdWJsaWNQcm9qZWN0KFxuICAgIHB1YmxpY1Byb2plY3RJZFxuICApXG4gIGNvbnN0IHByaXZhdGVJZFRvUHVibGljSWQgPSBuZXcgTWFwKClcbiAgcHJpdmF0ZVN0b3JpZXNJblB1YmxpY1Byb2plY3QuZm9yRWFjaChzdG9yeSA9PiB7XG4gICAgcHJpdmF0ZUlkVG9QdWJsaWNJZC5zZXQoc3RvcnkucHJpdmF0ZUlkLCBzdG9yeS5pZClcbiAgfSlcblxuICBhcHAuc2V0KCdzdG9yaWVzVG9UcmFjaycsIHByaXZhdGVTdG9yaWVzSW5QdWJsaWNQcm9qZWN0KVxuICBhcHAuc2V0KCdwcml2YXRlSWRUb1B1YmxpY0lkJywgcHJpdmF0ZUlkVG9QdWJsaWNJZClcblxuICBhd2FpdCBwcm9taXNpZnkoYXBwLmxpc3Rlbi5iaW5kKGFwcCkpKGNvbmZpZy5wb3J0KVxuXG4gIHJldHVybiBjb25maWcucG9ydFxufVxuXG5mdW5jdGlvbiBuZWVkVG9Qcm9jZXNzKFxuICBhY3Rpdml0eTogQWN0aXZpdHksXG4gIHN0b3JpZXM6IFByaXZhdGVTdG9yeUluUHVibGljUHJvamVjdFtdLFxuICBwcml2YXRlUHJvamVjdElkOiBudW1iZXJcbikge1xuICBjb25zdCBzdG9yeUlkcyA9IHN0b3JpZXMubWFwKHN0b3J5ID0+IHN0b3J5LnByaXZhdGVJZClcblxuICByZXR1cm4gKFxuICAgIHRydWUgJiZcbiAgICBhY3Rpdml0eS5wcm9qZWN0LmlkID09PSBwcml2YXRlUHJvamVjdElkICYmXG4gICAgYWN0aXZpdHkua2luZCA9PT0gJ3N0b3J5X3VwZGF0ZV9hY3Rpdml0eScgJiZcbiAgICBhY3Rpdml0eS5wcmltYXJ5X3Jlc291cmNlcy5sZW5ndGggJiZcbiAgICBhY3Rpdml0eS5wcmltYXJ5X3Jlc291cmNlc1swXS5raW5kID09PSAnc3RvcnknICYmXG4gICAgc3RvcnlJZHMuaW5jbHVkZXMoYWN0aXZpdHkucHJpbWFyeV9yZXNvdXJjZXNbMF0uaWQpICYmXG4gICAgYWN0aXZpdHkuY2hhbmdlcy5sZW5ndGggJiZcbiAgICBhY3Rpdml0eS5jaGFuZ2VzWzBdLm5ld192YWx1ZXMuY3VycmVudF9zdGF0ZSAhPSBudWxsXG4gIClcbn1cblxuZnVuY3Rpb24gZ2V0QWdncmVnYXRlZFN0YXRlKFxuICBhY3Rpdml0eTogQWN0aXZpdHksXG4gIHByaXZhdGVJZFRvUHVibGljSWQ6IE1hcDxudW1iZXIsIG51bWJlcj5cbik6IFN0b3J5QWdncmVnYXRlZCB7XG4gIGNvbnN0IHByaXZhdGVTdG9yeSA9IGFjdGl2aXR5LnByaW1hcnlfcmVzb3VyY2VzWzBdXG4gIGNvbnN0IHB1YmxpY0lkID0gcHJpdmF0ZUlkVG9QdWJsaWNJZC5nZXQocHJpdmF0ZVN0b3J5LmlkKVxuXG4gIHJldHVybiB7XG4gICAgcHJpdmF0ZUlkOiBwcml2YXRlU3RvcnkuaWQsXG4gICAgcHVibGljSWQsXG4gICAgbmFtZTogcHJpdmF0ZVN0b3J5Lm5hbWUsXG4gICAgY3VycmVudFN0YXRlOiBhY3Rpdml0eS5jaGFuZ2VzWzBdLm9yaWdpbmFsX3ZhbHVlcy5jdXJyZW50X3N0YXRlLFxuICAgIGFjdHVhbFN0YXRlOiBhY3Rpdml0eS5jaGFuZ2VzWzBdLm5ld192YWx1ZXMuY3VycmVudF9zdGF0ZSxcbiAgICBwcml2YXRlVXJsOiBwcml2YXRlU3RvcnkudXJsLFxuICAgIHB1YmxpY1VybDogZ2V0U3RvcnlVcmwocHVibGljSWQpLFxuICB9XG59XG4iXX0=